{% extends "gestao/base.html" %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Formulário de Cliente" }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ titulo_pagina }}</h1>
</div>

<form method="post" id="clienteForm" novalidate>
    {% csrf_token %}
    <div class="card shadow-sm">
        <div class="card-body">
            {% if form.non_field_errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {% for error in form.non_field_errors %}
                        <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endif %}

            <fieldset class="mb-4">
                <legend class="h5 mb-3 border-bottom pb-2">Identificação</legend>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.tipo_pessoa.id_for_label }}" class="form-label form-label-sm">{{ form.tipo_pessoa.label }}{% if form.tipo_pessoa.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                        {{ form.tipo_pessoa }}
                        {% if form.tipo_pessoa.errors %}<div class="invalid-feedback d-block">{{ form.tipo_pessoa.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-9 mb-3">
                        <label for="{{ form.nome_razao_social.id_for_label }}" class="form-label form-label-sm">{{ form.nome_razao_social.label }}{% if form.nome_razao_social.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                        {{ form.nome_razao_social }}
                        {% if form.nome_razao_social.errors %}<div class="invalid-feedback d-block">{{ form.nome_razao_social.errors|join:", " }}</div>{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.cpf_cnpj.id_for_label }}" class="form-label form-label-sm">{{ form.cpf_cnpj.label }}{% if form.cpf_cnpj.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                        {{ form.cpf_cnpj }}
                        {% if form.cpf_cnpj.errors %}<div class="invalid-feedback d-block">{{ form.cpf_cnpj.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-8 mb-3" id="divNomeFantasia" style="display: none;">
                        <label for="{{ form.nome_fantasia.id_for_label }}" class="form-label form-label-sm">{{ form.nome_fantasia.label }}</label>
                        {{ form.nome_fantasia }}
                        {% if form.nome_fantasia.errors %}<div class="invalid-feedback d-block">{{ form.nome_fantasia.errors|join:", " }}</div>{% endif %}
                    </div>
                </div>
            </fieldset>

            <div id="camposPessoaFisica" style="display: none;">
                <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-1">Dados de Pessoa Física</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.rg.id_for_label }}" class="form-label form-label-sm">{{ form.rg.label }}</label>
                            {{ form.rg }}
                            {% if form.rg.errors %}<div class="invalid-feedback d-block">{{ form.rg.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.orgao_emissor.id_for_label }}" class="form-label form-label-sm">{{ form.orgao_emissor.label }}</label>
                            {{ form.orgao_emissor }}
                            {% if form.orgao_emissor.errors %}<div class="invalid-feedback d-block">{{ form.orgao_emissor.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.data_nascimento.id_for_label }}" class="form-label form-label-sm">{{ form.data_nascimento.label }}</label>
                            {{ form.data_nascimento }}
                            {% if form.data_nascimento.errors %}<div class="invalid-feedback d-block">{{ form.data_nascimento.errors|join:", " }}</div>{% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.estado_civil.id_for_label }}" class="form-label form-label-sm">{{ form.estado_civil.label }}</label>
                            {{ form.estado_civil }}
                            {% if form.estado_civil.errors %}<div class="invalid-feedback d-block">{{ form.estado_civil.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.profissao.id_for_label }}" class="form-label form-label-sm">{{ form.profissao.label }}</label>
                            {{ form.profissao }}
                            {% if form.profissao.errors %}<div class="invalid-feedback d-block">{{ form.profissao.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.nacionalidade.id_for_label }}" class="form-label form-label-sm">{{ form.nacionalidade.label }}</label>
                            {{ form.nacionalidade }}
                            {% if form.nacionalidade.errors %}<div class="invalid-feedback d-block">{{ form.nacionalidade.errors|join:", " }}</div>{% endif %}
                        </div>
                    </div>
                </fieldset>
            </div>

            <div id="camposPessoaJuridica" style="display: none;">
                <fieldset class="mb-4">
                    <legend class="h6 mb-3 border-bottom pb-1">Dados de Pessoa Jurídica</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.nire.id_for_label }}" class="form-label form-label-sm">{{ form.nire.label }}</label>
                            {{ form.nire }}
                            {% if form.nire.errors %}<div class="invalid-feedback d-block">{{ form.nire.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.inscricao_estadual.id_for_label }}" class="form-label form-label-sm">{{ form.inscricao_estadual.label }}</label>
                            {{ form.inscricao_estadual }}
                            {% if form.inscricao_estadual.errors %}<div class="invalid-feedback d-block">{{ form.inscricao_estadual.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.inscricao_municipal.id_for_label }}" class="form-label form-label-sm">{{ form.inscricao_municipal.label }}</label>
                            {{ form.inscricao_municipal }}
                            {% if form.inscricao_municipal.errors %}<div class="invalid-feedback d-block">{{ form.inscricao_municipal.errors|join:", " }}</div>{% endif %}
                        </div>
                    </div>
                </fieldset>
            </div>

            <fieldset class="mb-4">
                <legend class="h6 mb-3 border-bottom pb-1">Endereço</legend>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.cep.id_for_label }}" class="form-label form-label-sm">{{ form.cep.label }}</label>
                        {{ form.cep }}
                        {% if form.cep.errors %}<div class="invalid-feedback d-block">{{ form.cep.errors|join:", " }}</div>{% endif %}
                        <div id="cep-feedback" class="form-text"></div>
                    </div>
                    <div class="col-md-7 mb-3">
                        <label for="{{ form.rua.id_for_label }}" class="form-label form-label-sm">{{ form.rua.label }}</label>
                        {{ form.rua }}
                        {% if form.rua.errors %}<div class="invalid-feedback d-block">{{ form.rua.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="{{ form.numero.id_for_label }}" class="form-label form-label-sm">{{ form.numero.label }}</label>
                        {{ form.numero }}
                        {% if form.numero.errors %}<div class="invalid-feedback d-block">{{ form.numero.errors|join:", " }}</div>{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.bairro.id_for_label }}" class="form-label form-label-sm">{{ form.bairro.label }}</label>
                        {{ form.bairro }}
                        {% if form.bairro.errors %}<div class="invalid-feedback d-block">{{ form.bairro.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.cidade.id_for_label }}" class="form-label form-label-sm">{{ form.cidade.label }}</label>
                        {{ form.cidade }}
                        {% if form.cidade.errors %}<div class="invalid-feedback d-block">{{ form.cidade.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="{{ form.estado.id_for_label }}" class="form-label form-label-sm">{{ form.estado.label }}</label>
                        {{ form.estado }}
                        {% if form.estado.errors %}<div class="invalid-feedback d-block">{{ form.estado.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="{{ form.pais.id_for_label }}" class="form-label form-label-sm">{{ form.pais.label }}</label>
                        {{ form.pais }}
                        {% if form.pais.errors %}<div class="invalid-feedback d-block">{{ form.pais.errors|join:", " }}</div>{% endif %}
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend class="h6 mb-3 border-bottom pb-1">Contato</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.telefone.id_for_label }}" class="form-label form-label-sm">{{ form.telefone.label }}</label>
                        {{ form.telefone }}
                        {% if form.telefone.errors %}<div class="invalid-feedback d-block">{{ form.telefone.errors|join:", " }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label form-label-sm">{{ form.email.label }}</label>
                        {{ form.email }}
                        {% if form.email.errors %}<div class="invalid-feedback d-block">{{ form.email.errors|join:", " }}</div>{% endif %}
                    </div>
                </div>
            </fieldset>
            
            <div class="mb-3">
                <label for="{{ form.notas_gerais.id_for_label }}" class="form-label form-label-sm">{{ form.notas_gerais.label }}</label>
                {{ form.notas_gerais }}
                {% if form.notas_gerais.errors %}<div class="invalid-feedback d-block">{{ form.notas_gerais.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="mt-4 pt-3 border-top">
                <button type="submit" class="btn btn-primary btn-sm px-4">Salvar Cliente</button>
                <a href="{% if object %}{% url 'gestao:cliente_detail' object.pk %}{% else %}{% url 'gestao:cliente_list' %}{% endif %}" class="btn btn-outline-secondary btn-sm ms-2 px-3">Cancelar</a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoPessoaSelect = document.getElementById('{{ form.tipo_pessoa.id_for_label }}');
    const camposPF = document.getElementById('camposPessoaFisica');
    const camposPJ = document.getElementById('camposPessoaJuridica');
    const divNomeFantasia = document.getElementById('divNomeFantasia');
    const nacionalidadeInput = document.getElementById('{{ form.nacionalidade.id_for_label }}');

    function toggleCampos() {
        if (!tipoPessoaSelect) return;
        const isPF = tipoPessoaSelect.value === 'PF';
        
        if(camposPF) camposPF.style.display = isPF ? '' : 'none';
        if(camposPJ) camposPJ.style.display = isPF ? 'none' : '';
        if(divNomeFantasia) divNomeFantasia.style.display = isPF ? 'none' : '';

        if (isPF && nacionalidadeInput && !nacionalidadeInput.value) {
            nacionalidadeInput.value = 'Brasileiro(a)';
        } else if (!isPF && nacionalidadeInput) {
            // Limpar ou ajustar nacionalidade para PJ se necessário, ou deixar como está
        }
    }

    if (tipoPessoaSelect) {
        tipoPessoaSelect.addEventListener('change', toggleCampos);
        toggleCampos(); // Chama na carga da página para o estado inicial correto
    }

    // Integração ViaCEP
    const cepInput = document.getElementById('id_cep_cliente');
    const ruaInput = document.getElementById('id_rua_cliente');
    const bairroInput = document.getElementById('id_bairro_cliente');
    const cidadeInput = document.getElementById('id_cidade_cliente');
    const estadoSelect = document.getElementById('id_estado_cliente'); // Assumindo que 'estado' é um select
    const cepFeedback = document.getElementById('cep-feedback');

    if (cepInput) {
        cepInput.addEventListener('blur', function() {
            const cep = this.value.replace(/\D/g, ''); // Remove não numéricos
            if (cep.length === 8) {
                if(cepFeedback) cepFeedback.textContent = 'Buscando CEP...';
                if(cepFeedback) cepFeedback.className = 'form-text text-muted';
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.erro) {
                            if(cepFeedback) cepFeedback.textContent = 'CEP não encontrado.';
                            if(cepFeedback) cepFeedback.className = 'form-text text-danger';
                            if(ruaInput) ruaInput.value = '';
                            if(bairroInput) bairroInput.value = '';
                            if(cidadeInput) cidadeInput.value = '';
                            if(estadoSelect) estadoSelect.value = '';
                        } else {
                            if(cepFeedback) cepFeedback.textContent = 'Endereço carregado!';
                            if(cepFeedback) cepFeedback.className = 'form-text text-success';
                            if(ruaInput) ruaInput.value = data.logradouro || '';
                            if(bairroInput) bairroInput.value = data.bairro || '';
                            if(cidadeInput) cidadeInput.value = data.localidade || '';
                            if(estadoSelect) estadoSelect.value = data.uf || ''; // Para campos select, o valor deve corresponder ao 'value' da option
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar CEP:', error);
                        if(cepFeedback) cepFeedback.textContent = 'Erro ao buscar CEP.';
                        if(cepFeedback) cepFeedback.className = 'form-text text-danger';
                    });
            } else {
                if (cep.length > 0 && cepFeedback) { // Só mostra erro se algo foi digitado e é inválido
                    if(cepFeedback) cepFeedback.textContent = 'CEP inválido.';
                    if(cepFeedback) cepFeedback.className = 'form-text text-danger';
                } else if (cepFeedback) {
                    cepFeedback.textContent = ''; // Limpa se o campo estiver vazio
                }
            }
        });
    }
});
</script>
{% endblock %}
